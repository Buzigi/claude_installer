name: CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  release:
    types: [published]

env:
  VERSION: ${{ github.event.release.tag_name || 'dev' }}

jobs:
  validate:
    name: Validate Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PowerShell Syntax
        run: |
          # Install PowerShell
          sudo apt-get update
          sudo apt-get install -y powershell

          # Check syntax of all PS1 files
          pwsh -Command "
            Get-ChildItem -Filter '*.ps1' -Recurse | ForEach-Object {
              try {
                \$null = [System.Management.Automation.PSParser]::Tokenize((Get-Content \$_.FullName -Raw), [ref]\$null)
                Write-Host '✓' \$_.Name
              } catch {
                Write-Error \"Syntax error in \$(\$_.Name): \$_\"
                exit 1
              }
            }
          "

      - name: Validate Bash Syntax
        run: |
          echo "Validating shell scripts..."
          find . -name "*.sh" -type f | while read -r file; do
            if bash -n "$file" 2>/dev/null; then
              echo "✓ $file"
            else
              echo "✗ Syntax error in $file"
              exit 1
            fi
          done

      - name: Check for unresolved comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          if grep -r "TODO\|FIXME" --include="*.ps1" --include="*.sh" .; then
            echo "Warning: Found unresolved TODO/FIXME comments (not blocking)"
          else
            echo "✓ No unresolved comments found"
          fi

  test-windows:
    name: Test Windows Installer
    runs-on: windows-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test PowerShell Syntax
        shell: powershell
        run: |
          # Validate script loads without syntax errors
          $errors = $null
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content .\Install-ClaudeCode.ps1 -Raw),
            [ref]$errors
          )
          if ($errors) {
            Write-Error "Syntax errors found: $errors"
            exit 1
          }
          Write-Host "✓ Install-ClaudeCode.ps1 syntax valid"

          # Also check uninstaller
          $null = [System.Management.Automation.PSParser]::Tokenize(
            (Get-Content .\Uninstall-ClaudeCode.ps1 -Raw),
            [ref]$errors
          )
          if ($errors) {
            Write-Error "Syntax errors in uninstaller: $errors"
            exit 1
          }
          Write-Host "✓ Uninstall-ClaudeCode.ps1 syntax valid"

  test-linux:
    name: Test Linux Installer
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Bash Scripts
        run: |
          chmod +x install-claude-code.sh uninstall-claude-code.sh

          # Validate syntax
          bash -n install-claude-code.sh && echo "✓ install-claude-code.sh syntax valid"
          bash -n uninstall-claude-code.sh && echo "✓ uninstall-claude-code.sh syntax valid"

          # Check for common issues
          echo "Checking for shellcheck issues..."
          sudo apt-get install -y shellcheck
          shellcheck install-claude-code.sh || echo "ShellCheck warnings (not blocking)"
          shellcheck uninstall-claude-code.sh || echo "ShellCheck warnings (not blocking)"

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: [test-windows, test-linux]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build Windows Installer
        shell: powershell
        run: |
          $version = "${{ env.VERSION }}" -replace '^v', ''
          if ([string]::IsNullOrEmpty($version)) { $version = "1.0.0" }
          iscc /DAppVersion="$version" installer\windows\claude-installer.iss

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.exe
          retention-days: 1

  build-linux-deb:
    name: Build Linux .deb Package
    runs-on: ubuntu-latest
    needs: [test-windows, test-linux]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dpkg-deb
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev

      - name: Build .deb Package
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          chmod +x installer/linux/deb/build-deb.sh
          ./installer/linux/deb/build-deb.sh "$VERSION"

      - name: Upload .deb Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: dist/*.deb
          retention-days: 1

  build-linux-rpm:
    name: Build Linux .rpm Package
    runs-on: ubuntu-latest
    needs: [test-windows, test-linux]
    if: github.event_name == 'release'
    container:
      image: rockylinux:9

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install RPM Build Tools
        run: |
          dnf install -y rpm-build rpmdevtools tar gzip

      - name: Build .rpm Package
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          chmod +x installer/linux/rpm/build-rpm.sh
          ./installer/linux/rpm/build-rpm.sh "$VERSION"

      - name: Upload .rpm Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: dist/*.rpm
          retention-days: 1

  build-linux-appimage:
    name: Build Linux AppImage
    runs-on: ubuntu-latest
    needs: [test-windows, test-linux]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl file desktop-file-utils squashfs-tools

      - name: Build AppImage
        env:
          APPIMAGE_EXTRACT_AND_RUN: 1
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          chmod +x installer/linux/appimage/build-appimage.sh
          ./installer/linux/appimage/build-appimage.sh "$VERSION"

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: dist/*.AppImage
          retention-days: 1

  release:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux-deb, build-linux-rpm, build-linux-appimage]
    if: github.event_name == 'release'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Assets
        run: |
          mkdir -p release

          # Copy raw scripts (backward compatibility)
          cp Install-ClaudeCode.ps1 release/
          cp install-claude-code.sh release/
          cp Uninstall-ClaudeCode.ps1 release/
          cp uninstall-claude-code.sh release/

          # Copy built artifacts
          if [ -d "artifacts/windows-installer" ]; then
            cp artifacts/windows-installer/*.exe release/ 2>/dev/null || true
          fi
          if [ -d "artifacts/linux-deb" ]; then
            cp artifacts/linux-deb/*.deb release/ 2>/dev/null || true
          fi
          if [ -d "artifacts/linux-rpm" ]; then
            cp artifacts/linux-rpm/*.rpm release/ 2>/dev/null || true
          fi
          if [ -d "artifacts/linux-appimage" ]; then
            cp artifacts/linux-appimage/*.AppImage release/ 2>/dev/null || true
          fi

          # Create checksums
          cd release
          sha256sum * > checksums.sha256

          echo "Release assets prepared:"
          ls -la

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files are attached to this release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Platform |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          for f in release/*; do
            filename=$(basename "$f")
            if [[ "$filename" == *.exe ]]; then
              platform="Windows"
            elif [[ "$filename" == *.deb ]]; then
              platform="Debian/Ubuntu"
            elif [[ "$filename" == *.rpm ]]; then
              platform="RHEL/Fedora"
            elif [[ "$filename" == *.AppImage ]]; then
              platform="Linux (Universal)"
            elif [[ "$filename" == *.ps1 ]]; then
              platform="Windows (Script)"
            elif [[ "$filename" == *.sh ]]; then
              platform="Linux/macOS (Script)"
            elif [[ "$filename" == checksums* ]]; then
              platform="Checksums"
            else
              platform="Unknown"
            fi
            echo "| \`$filename\` | $platform |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat release/checksums.sha256 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
